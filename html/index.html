<!DOCTYPE=html>
<head>
  <title>Le Blackjack</title>
  <link rel="stylesheet" href="../css/site.css">
  <link rel="stylesheet" href="../css/bootstrap.min.css">
</head>
<body>
  <div class="container text-center">

    <!-- <div class="alert alert-success fade" role="alert">You win!</div>
    <div class="alert alert-danger fade" role="alert">You lose. :(</div> -->

    <div class="row">
      <div class="col-md-12">
        <h1 id="gameStatus"></h1>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <h2 id="dealerHandValue"></h2>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-6 col-xs-offset-5">
        <div id="dealer">
          <div id="empty" class="card"></div>
          <div id="hiddenCard" class="card"></div>
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-xs-6 col-xs-offset-5">
        <div id="player">
          <div id="empty" class="card"></div>
          <div id="empty" class="card"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <h2 id="playerHandValue"></h2>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <button id="dealButton" class="btn btn-default">Deal</button>
        <button id="hitButton" class="btn btn-default">Hit</button>
        <button id="standButton"  class="btn btn-default">Stand</button>
      </div>
    </div>

  </div>

  <script type="text/javascript" src="../js/blackjack.js"></script>
  <script type="text/javascript">
    // I kept this out of the blackjack.js file to separate the view from the controller,
    // and to make testing easier (?)

    var game = new Game();
    var player = new Player("player");
    var dealer = new Player("dealer");

    var playerCardsOnScreen = document.getElementById("player");
    var dealerCardsOnScreen = document.getElementById("dealer");
    var gameStatus = document.getElementById("gameStatus");

    /*Set up event listeners for buttons*/
    var hitButton = document.getElementById("hitButton");
    var standButton = document.getElementById("standButton");
    var dealButton = document.getElementById("dealButton");

    hitButton.addEventListener('click', function() {
      hitMe();
    }, false);

    standButton.addEventListener('click', function() {
      stand();
    }, false);

    dealButton.addEventListener('click', function() {
      game = new Game();
      game.shuffleCards();
      runGame();
    }, false);

    function initializeGame(){
      // Hide buttons
      hitButton.disabled = "";
      standButton.disabled = "";

      // Reset players' hands in DOM to empty
      playerCardsOnScreen.innerHTML = "<div id='empty' class='card'></div><div id='empty' class='card'></div>";
      dealerCardsOnScreen.innerHTML = "<div id='empty' class='card'></div><div id='hiddenCard' class='card'></div>";

      // Reset the players' hands
      player.cards = [];
      dealer.cards = [];

      document.getElementById("playerHandValue").innerHTML = "";
      document.getElementById("dealerHandValue").innerHTML = "";

      gameStatus.innerHTML = "";

    }

    // Game functions that should maybe (?) go in the other file.
    function runGame(){
      initializeGame();

      // Deal 2 cards to each player
      game.dealCard(player,2);
      game.dealCard(dealer,2);

      // Update DOM to match dealt cards
      for(var i in player.cards){
        var card = player.cards[i];
        var cardBox = playerCardsOnScreen.getElementsByTagName("div")[i];
        cardBox.id = card.name;
        setBackgroundImage(cardBox, card.name);
      }

      var dealerCard = document.getElementById("dealer").getElementsByClassName("card")[0];
      dealerCard.id = dealer.cards[0].name;
      setBackgroundImage(dealerCard, dealer.cards[0].name);

      // Update display for score of cards currently held by player
      game.calculateScore(player);
      updateHandValue(player);

      // Allow card images to render, then check if the player has already reached 21
      setTimeout(function(){
        initialScore();
      }, 200);
    }

    // When player presses "Hit Me" button...
    function hitMe(){
      game.dealCard(player, 1);

      // Create a new DOM element
      var newCard = document.createElement("div");

      // Find the name of the new card that has been dealt and add it to the DOM element
      var card = player.cards[player.cards.length-1];
      newCard.id = card.name;

      // Set the styling
      newCard.className = "card";
      setBackgroundImage(newCard, card.name);

      // Add new element to the DOM
      playerCardsOnScreen.appendChild(newCard);

      game.calculateScore(player);
      updateHandValue(player);

      // Use a timeout to let the card images render before checking score
      setTimeout(function(){
        initialScore();
      }, 100);
    }

    function stand(){
      // First show the second card the dealer already has in their hand
      var dealerCardsOnScreen = document.getElementById("dealer");

      var dealerCard = dealerCardsOnScreen.getElementsByClassName("card")[1];
      dealerCard.id = dealer.cards[1].name;
      setBackgroundImage(dealerCard, dealer.cards[1].name);

      // Then while the dealer's score is less than 17, keep dealing cards and displaying them
      var i = 2;
      while(game.calculateScore(dealer) < 17){
        game.dealCard(dealer,1);
        var newCard = document.createElement("div");
        newCard.id = dealer.cards[i].name;
        newCard.className = "card";
        setBackgroundImage(newCard, dealer.cards[i].name);
        dealerCardsOnScreen.appendChild(newCard);
        i++;
      }

      updateHandValue(dealer);

      finalScore();
    }

    function finalScore(){
      if(game.calculateScore(dealer) > 21){
        gameStatus.innerHTML = "You win, dealer busts!";
      } else if (game.calculateScore(dealer) === 21 ){
        gameStatus.innerHTML = "Dealer wins!";
      } else if(game.calculateScore(player) === 21){
        gameStatus.innerHTML = "21, you win!";
      } else if (game.calculateScore(player) > game.calculateScore(dealer)){
        gameStatus.innerHTML = "You win!";
      } else if (game.calculateScore(player) <= game.calculateScore(dealer)){
        gameStatus.innerHTML = "You lose!";
      }

      endGame();
    }

    function initialScore(){
      if(game.calculateScore(player) > 21){
        gameStatus.innerHTML = "Busted! You're over 21!";
        endGame();
      }

      if(game.calculateScore(dealer) > 21){
        gameStatus.innerHTML = "Dealer loses! You win!";
        endGame();
      }

    };

    function setBackgroundImage(cardElement, cardName){
      cardElement.style.backgroundImage = "url(../img/cards/" + cardName + ".png)";
    }

    function updateHandValue(player){
      var hand = document.getElementById(player.name + "HandValue");
      hand.innerHTML = game.calculateScore(player);
    }

    function endGame(){
      // Disable hit and stand buttons
      hitButton.disabled = "disabled";
      standButton.disabled = "disabled";

      // Show the dealer's second card (useful if bust after a hit)
      var dealerCard = document.getElementById("dealer").getElementsByClassName("card")[1];
      dealerCard.id = dealer.cards[1].name;
      setBackgroundImage(dealerCard, dealer.cards[1].name);
    }

    game.shuffleCards();
    runGame();

  </script>

</body>
</html>
